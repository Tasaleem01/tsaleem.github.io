import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, set, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
import { getAuth, createUserWithEmailAndPassword, sendEmailVerification, reload } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

const firebaseConfig = {
    apiKey: "AIzaSyA3YrKmw3sAdl2pld-KRCb7wbf3xlnw8G0",
    authDomain: "tasaleem-c2218.firebaseapp.com",
    databaseURL: "https://tasaleem-c2218-default-rtdb.firebaseio.com",
    projectId: "tasaleem-c2218",
    storageBucket: "tasaleem-c2218.firebasestorage.app",
    messagingSenderId: "877790432223",
    appId: "1:877790432223:web:5d7b6a4423f2198af8126a"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const auth = getAuth(app);

const regForm = document.getElementById('regForm');
const regMessage = document.getElementById('regMessage');

regForm.addEventListener('submit', async (e) => {
    e.preventDefault();

    const name = document.getElementById('regName').value;
    const email = document.getElementById('regEmail').value;
    const academicId = document.getElementById('regIndex').value;
    const college = document.getElementById('regCollege').value;
    const password = document.getElementById('regPass').value;

    try {
        // 1. Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨ ÙÙŠ Ù†Ø¸Ø§Ù… Ø§Ù„Ø­Ù…Ø§ÙŠØ©
        const userCredential = await createUserWithEmailAndPassword(auth, email, password);
        const user = userCredential.user;

        // 2. Ø¥Ø±Ø³Ø§Ù„ Ø±Ø§Ø¨Ø· Ø§Ù„ØªÙØ¹ÙŠÙ„ (Ø³ÙŠØµÙ„Ùƒ Ø¥ÙŠÙ…ÙŠÙ„ Ù…Ù† Firebase)
        await sendEmailVerification(user);

        // 3. Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ø§Ù„Ù‚Ø§Ø¹Ø¯Ø© Ù„Ù„Ø¢Ø¯Ù…Ù†
        const userData = {
            fullName: name,
            email: email,
            academicIndex: academicId,
            college: college,
            uid: user.uid
        };
        await set(ref(db, 'users/' + academicId), userData);
        localStorage.setItem('user', JSON.stringify(userData));

        // 4. ØªØºÙŠÙŠØ± Ø´ÙƒÙ„ Ø§Ù„ØµÙØ­Ø© Ù„Ø¥Ø¬Ø¨Ø§Ø± Ø§Ù„Ø·Ø§Ù„Ø¨ Ø¹Ù„Ù‰ Ø§Ù„ØªÙØ¹ÙŠÙ„
        regForm.innerHTML = `
            <div class="text-center p-6 bg-white rounded-3xl shadow-xl border-2 border-blue-500">
                <h3 class="text-xl font-bold text-blue-700">ğŸ“§ ØªÙÙ‚Ø¯ Ø¨Ø±ÙŠØ¯Ùƒ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</h3>
                <p class="text-sm text-gray-600 my-4">Ø£Ø±Ø³Ù„Ù†Ø§ Ø±Ø§Ø¨Ø· ØªÙØ¹ÙŠÙ„ Ù„Ù€: <br><b>${email}</b></p>
                <p class="text-xs text-red-500 mb-4">(Ø¥Ø°Ø§ Ù„Ù… ØªØ¬Ø¯Ù‡Ø§ØŒ Ø§Ø¨Ø­Ø« ÙÙŠ Spam Ø£Ùˆ Junk)</p>
                
                <button id="checkAuthBtn" class="w-full bg-green-600 text-white py-3 rounded-xl font-bold mb-3">Ù„Ù‚Ø¯ Ø¶ØºØ·Øª Ø¹Ù„Ù‰ Ø§Ù„Ø±Ø§Ø¨Ø·ØŒ Ø§Ø¯Ø®Ù„Ù†ÙŠ Ø§Ù„Ø¢Ù† âœ…</button>
                <button id="resendMail" class="text-blue-600 underline text-xs">Ø¥Ø¹Ø§Ø¯Ø© Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø§Ø¨Ø·</button>
            </div>
        `;

        // ÙˆØ¸ÙŠÙØ© Ø²Ø± Ø§Ù„ØªØ­Ù‚Ù‚
        document.getElementById('checkAuthBtn').onclick = async () => {
            await reload(auth.currentUser); // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø© Ù„Ù…Ø¹Ø±ÙØ© Ù‡Ù„ Ø¶ØºØ· Ø§Ù„Ø±Ø§Ø¨Ø· Ø£Ù… Ù„Ø§
            if (auth.currentUser.emailVerified) {
                alert("ØªÙ… Ø§Ù„ØªÙØ¹ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­! Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙˆØ¬ÙŠÙ‡...");
                window.location.href = 'index.html';
            } else {
                alert("Ø¹Ø°Ø±Ø§Ù‹ØŒ Ù„Ù… ØªØ¶ØºØ· Ø¹Ù„Ù‰ Ø±Ø§Ø¨Ø· Ø§Ù„ØªÙØ¹ÙŠÙ„ ÙÙŠ Ø¨Ø±ÙŠØ¯Ùƒ Ø¨Ø¹Ø¯.");
            }
        };

        // ÙˆØ¸ÙŠÙØ© Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¥Ø±Ø³Ø§Ù„
        document.getElementById('resendMail').onclick = async () => {
            await sendEmailVerification(auth.currentUser);
            alert("ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø§Ø¨Ø·ØŒ ØªÙÙ‚Ø¯ Ø¨Ø±ÙŠØ¯Ùƒ.");
        };

    } catch (error) {
        alert("Ø®Ø·Ø£: " + error.message);
    }
});
